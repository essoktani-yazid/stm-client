name: Build Windows Installer

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
    # 1. Récupération du code
    - name: Checkout code
      uses: actions/checkout@v4

    # 2. Installation de Java 21
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'maven'

    # 3. Compilation de TOUT le projet (pour inclure stm-common)
    - name: Build with Maven
      run: mvn clean install -DskipTests

    # 4. Création de l'EXE avec JPackage
    - name: Create Installer with JPackage
      run: |
        # On se déplace dans le dossier stm-client
        cd stm-client
        
        # On identifie le fichier JAR généré
        $JAR_FILE = "stm-client-1.0.0.jar"
        
        echo "Création de l'installable pour $JAR_FILE..."
        
        # Commande JPackage
        jpackage `
          --type exe `
          --input target `
          --name "SmartTaskManager" `
          --main-jar $JAR_FILE `
          --main-class com.smarttask.client.Launcher `
          --win-dir-chooser `
          --win-menu `
          --win-shortcut `
          --app-version "1.0.0" `
          --dest installer

    # 5. Téléchargement du résultat (Artifact)
    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: SmartTaskManager-Setup
        path: stm-client/installer/*.exe